# 内核层 - 工作流执行引擎

**内核层**是执行设计层中设计的业务流程的运行时引擎。该层实现了受操作系统启发的流程管理系统，将业务操作视为可调度的计算流程。

## 核心架构

### 业务流程即操作系统流程的隐喻

内核使用操作系统概念实现业务流程管理：
- **进程控制块 (PCB)** - 每个业务操作都成为可调度的流程
- **流程状态** - NEW、READY、RUNNING、WAITING、SUSPENDED、TERMINATED
- **资源调度** - 将CPU调度算法应用于业务资源分配
- **上下文切换** - 操作员可以在不同业务活动之间切换
- **基于优先级的执行** - 业务流程根据优先级队列执行

### 核心组件

## 流程管理核心

**Process模型** - 代表业务操作的中心实体：
- **PID管理** - 带自动递增的唯一流程标识符
- **状态管理** - 完整的流程生命周期跟踪
- **分层流程** - 父子和顺序流程关系
- **实体绑定** - 与任何业务实体的通用外键绑定
- **操作员分配** - 资源分配和任务分配
- **服务集成** - 链接到设计层的服务定义

**流程状态** (types.py)：
```python
ProcessState.NEW       # 流程创建时的初始状态
ProcessState.READY     # 准备执行，等待操作员
ProcessState.RUNNING   # 当前正在被操作员执行
ProcessState.WAITING   # 等待外部事件或资源
ProcessState.SUSPENDED # 被系统或操作员暂时挂起
ProcessState.TERMINATED # 流程完成或取消
```

**ProcessContextSnapshot** - 流程状态版本控制：
- **版本控制** - 跟踪流程状态随时间的变化
- **上下文数据** - 流程执行上下文的JSON存储
- **哈希验证** - 流程状态的完整性检查

## 资源管理系统

**资源抽象** - 统一资源管理：
- **ResourceRequirement** - 抽象资源类型定义
- **ResourceStatus** - 实时资源可用性跟踪
- **ResourceCalendar** - 基于时间的资源调度
- **容量管理** - 多流程资源共享

**资源调度算法**：
- **容量跟踪** - 监控当前资源使用量与容量
- **时间窗管理** - 在可用性窗口内调度资源
- **冲突解决** - 处理流程间的资源争用
- **基于优先级的分配** - 更高优先级的流程获得资源优先权

## 操作员管理

**Operator模型** - 人力资源管理：
- **任务分配** - 操作员接收和执行流程
- **上下文切换** - 在不同业务活动之间切换
- **基于角色的访问** - 通过角色分配的服务权限
- **任务列表** - 管理操作员工作负载和优先级

**操作员方法**：
- `get_task_list(state_set)` - 检索特定状态的流程
- `switch_task(from_process, to_process)` - 任务间的上下文切换
- `allowed_services()` - 基于角色获取操作员可访问的服务

## 事件驱动架构

**事件处理系统** - 自动化工作流触发器：
- **基于信号的自动化** - Django信号触发流程状态变化
- **表达式评估** - 工作流规则的动态条件检查
- **实时状态同步** - 自动流程状态更新
- **解耦通信** - 组件通过事件通信

**Event模型** - 触发条件定义：
- **表达式解析** - 评估复杂业务逻辑条件
- **参数传递** - 事件特定数据传输
- **定时器事件** - 基于计划的流程自动化

## 业务规则引擎

**ServiceRule模型** - 工作流自动化逻辑：
- **事件-服务绑定** - 连接触发器到业务操作
- **指令执行** - 系统命令处理
- **实体集成** - 规则可操作任何业务实体类型
- **参数配置** - 灵活的规则参数化

**规则评估流程**：
1. **事件检测** - 监控触发条件
2. **表达式评估** - 检查条件是否满足
3. **服务激活** - 执行关联的业务服务
4. **状态更新** - 更新流程和实体状态
5. **下一流程创建** - 链接到后续操作

## 调度器引擎

**Process Scheduler** (scheduler.py) - 核心执行管理：
- **优先级队列** - 管理流程执行顺序
- **资源分配** - 为就绪流程分配资源
- **时间管理** - 处理计划和时间窗流程
- **负载均衡** - 在可用操作员间分配工作

**调度算法**：
- **基于优先级的调度** - 优先执行高优先级流程
- **资源感知调度** - 考虑资源可用性
- **时间约束调度** - 处理计划和截止时间流程
- **操作员工作负载均衡** - 有效分配任务

## 信号系统

**流程信号** (signals.py) - 自动化状态管理：
- **状态变化触发器** - 自动流程生命周期管理
- **资源更新** - 实时资源状态同步
- **事件传播** - 相关流程间的级联效应
- **审计跟踪生成** - 跟踪所有流程状态变化

## 系统集成

### 设计层集成
- **服务执行** - 执行设计层中定义的服务
- **资源需求** - 遵守服务的资源规格
- **表单集成** - 显示与流程关联的表单
- **实体绑定** - 连接到设计层中定义的实体

### 应用层集成
- **模型绑定** - 流程可以绑定到任何应用模型
- **业务逻辑执行** - 在实体上触发业务操作
- **数据流管理** - 协调流程和实体间的数据

## 高级功能

### 多流程协调
- **父子流程** - 分层流程结构
- **顺序流程** - 工作流中的链式流程
- **并行执行** - 同一实体上的多个流程
- **同步点** - 协调并行工作流

### 资源优化
- **容量规划** - 优化资源利用率
- **冲突解决** - 处理资源争用
- **调度优化** - 最小化等待时间并最大化吞吐量
- **资源预测** - 预测资源需求

### 错误处理和恢复
- **流程回滚** - 将流程恢复到之前状态
- **错误状态管理** - 优雅处理流程失败
- **恢复程序** - 自动和手动恢复机制
- **审计和合规** - 跟踪所有流程活动

## 文件结构

- `models.py` - 核心流程和资源模型
- `scheduler.py` - 流程调度算法
- `signals.py` - 事件驱动自动化
- `tasks.py` - Celery异步任务定义
- `types.py` - 流程状态和类型定义
- `utils.py` - 流程管理工具
- `resource_manage.py` - 资源分配算法
- `consumers.py` - WebSocket实时更新
- `routing.py` - WebSocket URL路由

## 使用模式

### 流程创建
```python
process = Process.objects.create(
    service=service,
    entity_content_object=business_entity,
    operator=assigned_operator,
    state=ProcessState.READY.name
)
```

### 资源分配
```python
# 检查资源可用性
if resource_status.current_usage < resource_status.capacity:
    # 为流程分配资源
    process.state = ProcessState.RUNNING.name
```

### 事件驱动自动化
```python
# 当事件条件满足时ServiceRule触发
if event.evaluate_expression(process_context):
    execute_system_instruction(instruction, process)
    create_next_process(operand_service, entity)
```

内核层代表ERP框架最复杂的方面 - 为业务操作实现真正的计算流程管理，具有先进的调度、资源管理和自动化能力。